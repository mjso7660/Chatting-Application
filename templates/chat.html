<!------ Include the above in your HEAD tag ---------->


<html>
<head>

<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/chat.css') }}">
<link rel="shortcut icon" href="">
</head>
<body>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
    <script type="text/javascript">
	  function log_out(){
		socket.emit('log_out',{data: ''})
	  }
      var socket = io.connect('http://' + document.domain + ':' + location.port);
      socket.on( 'connect', function() {
        socket.emit( 'boot', {
          data: 0
        } )
		socket.emit( 'test', {
          data: 0
        } )
        var form = $( 'form.chat' ).on( 'submit', function( e ) {
          e.preventDefault()
          let user_input = $( 'input.write_msg' ).val()
          socket.emit( 'my event', {
            message : user_input
          } )
          $( 'input.message' ).val( '' ).focus()
			this.reset();
			
        } )

		var form = $( 'form.search' ).on( 'submit', function( e ) {
          e.preventDefault()
          let user_input = $( 'input.search-bar' ).val()
          $('.incoming_msg').remove();
          $('.outgoing_msg').remove();
          socket.emit( 'search', {
            message : user_input
          } )
          $( 'input.message' ).val( '' ).focus()
			this.reset();
			
        } )
        var form = $( 'form.add' ).on( 'submit', function( e ) {
          e.preventDefault()
          let user_input = $( 'input.search-bar2' ).val()
          socket.emit('add',{
          	message: user_input
          })
        } )
      })
	  socket.on('message_history',function(his){
	    //console.log(his);
		
		len = Object(his).length
		for(var k = len-1; k >=0; k--){
		  if(his[k]['sender']=='me'){
			$( 'div.msg_history').append('<div class="outgoing_msg"><div class="sent_msg"><p>'+his[k]['message']+'</p><span class="time_date"> </span> </div></div>')
		  }else{
		    $( 'div.msg_history').append('<div class="incoming_msg"><div class="incoming_msg_img"> <img src="http://2014.igem.org/wiki/images/f/fe/Cooper-Union.png" alt="sunil"> </div> <div class="received_msg"><div class="received_withd_msg"> <p>'+his[k]['message']+'</p><span class="time_date"> </span></div></div></div>') 
		  }
		}
	  })
	  socket.on('update_list',function(msg){
		len = Object(msg).length;
		
		for(var i = 0; i < len; i++){
			$('div.inbox_chat').append('<div class="chat_list active_chat" onclick=test('+i+')><div class="chat_people"><div class="chat_img"> <img src="http://2014.igem.org/wiki/images/f/fe/Cooper-Union.png"></div><div class="chat_ib"><h5>'+msg[i]['users']+'<span class="chat_date">'+msg[i]['date']+'</span></h5><p>'+msg[i]['message']+'</p></div></div></div>')
		}
	  })
      socket.on( 'my response', function( msg ) {
	if((typeof msg.message!=='undefined') && msg.message.replace(/^\s+|\s+$/g,'') != ''){
          var dt = new Date()
	        $( 'div.msg_history').append('<div class="outgoing_msg"><div class="sent_msg"><p>'+msg.message+'</p><span class="time_date"> </span> </div></div>')
	}
      })
	  
	  function test(i){
		var tabs = document.querySelectorAll('.chat_list');
		for(var j = 0; j < tabs.length; j++){
			if(j == i){
				document.querySelectorAll('.chat_list')[j].className="chat_list active_chat";
				var name = document.querySelectorAll('.chat_ib > h5')[j].innerHTML.split("<")[0];
			}else{
				document.querySelectorAll('.chat_list')[j].className="chat_list";
			}	
		}
		$('.incoming_msg').remove();
		$('.outgoing_msg').remove();
		socket.emit('test',{
			data: i
		})
	  }
	  socket.on('no_user',function(e){
	  	console.log(e)
	  	alert('User ' + e.name + ' doesnt exist!')
	  })
	  
    </script>

<div class="container">
<h3 class=" text-center">Messaging</h3>
<div class="messaging">
      <div class="inbox_msg">
        <div class="inbox_people">
          <div class="headind_srch">
            <div class="recent_heading">
              <h4>Recent</h4>
            </div>
            <div class="srch_bar">
              <div class="stylish-input-group">
				<form action="" method="POST" class="search">
					<input type="text" class="search-bar"  placeholder="Search" >
					<span class="input-group-addon">
					<button type="button"> <i class="fa fa-search" aria-hidden="true"></i> </button>
					</span>
				</form>
			  </div>
			</div>
            <div class="recent_heading">
              <h4>Start new ></h4>
            </div>
            <div class='srch_bar'>
              <div class="stylish-input-group">
				<form action="" method="POST" class="add">
					<input type="text" class="search-bar2"  placeholder="Add member" >
					<span class="input-group-addon">
					<button type="button"> <i class="fa fa-search" aria-hidden="true"></i> </button>
					</span>
				</form>
			  </div>			  
            </div>
          </div>
          <div class="inbox_chat">
			
			<!--				INBOX CHAT COMES HERE				 -->
          
		  </div>
        </div>
		<div class="mesgs"> 
          <div class="msg_history"> 
		  
		  <!--				MSG COMES HERE				 -->		  
			<div class="incoming_msg"> 
              <div class="received_msg"> 
                <div class="received_withd_msg"> 
				 </div> 
             </div> 
          </div> 
		  <div class="message_holder"> 
		  </div> 
        </div> 
        <div class="type_msg"> 
            <div class="input_msg_write"> 
			  <form action="" method="POST" class="chat">
				  <input type="text" class="write_msg" placeholder="Type a message" /> 
				  <div class="msg_send_btn">
						  <input type="submit" class="msg_send_btn"></div>
			  </form>
            </div> 
        </div> 
      </div> 
</div> 

      
      
      <button type="button" method=get onclick="log_out()">Log Out</button>
      
    </div></div>

    </body>
    </html>
